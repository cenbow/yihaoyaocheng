<?xml version="1.0" encoding="UTF-8"?>
<!--
 **
 * Created By: XI
 * Created On: 2016-8-8 14:47:19
 *
 * Amendment History:
 *
 * Amended By       Amended On      Amendment Description
 * ************     ***********     *********************************************
 *
 **
 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yyw.yhyc.order.mapper.OrderExceptionMapper">
	<cache type="com.yyw.yhyc.cache.LoggingRedisCache"
		   flushInterval="86400000" size="1024000">
	</cache>
	<resultMap id="OrderExceptionResultMapper" type="OrderException">
		<result column="exception_id" property="exceptionId"/>
		<result column="return_type" property="returnType"/>
		<result column="exception_order_id" property="exceptionOrderId"/>
		<result column="order_id" property="orderId"/>
		<result column="flow_id" property="flowId"/>
		<result column="order_status" property="orderStatus"/>
		<result column="cust_name" property="custName"/>
		<result column="cust_id" property="custId"/>
		<result column="supply_name" property="supplyName"/>
		<result column="supply_id" property="supplyId"/>
		<result column="remark" property="remark"/>
		<result column="order_money_total" property="orderMoneyTotal"/>
		<result column="order_money" property="orderMoney"/>
		<result column="create_user" property="createUser"/>
		<result column="create_time" property="createTime"/>
		<result column="update_user" property="updateUser"/>
		<result column="update_time" property="updateTime"/>
		<result column="order_create_time" property="orderCreateTime"/>
		<result column="return_desc" property="returnDesc"/>
		<result column="deliver_time" property="deliverTime"/>
		<result column="receive_time" property="receiveTime"/>
		<result column="buyer_deliver_time" property="buyerDeliverTime"/>
		<result column="seller_receive_time" property="sellerReceiveTime"/>
		<result column="review_time" property="reviewTime"/>

	</resultMap>

	<sql id="commonColumns">
		exception_id
		, return_type
		, exception_order_id
		, order_id
		, flow_id
		, order_status
		, cust_name
		, cust_id
		, supply_name
		, supply_id
		, remark
		, order_money_total
		, order_money
		, create_user
		, create_time
		, update_user
		, update_time
		, order_create_time
		, return_desc
		, deliver_time
		, receive_time
		, buyer_deliver_time
		, seller_receive_time
		, review_time
	</sql>

	<sql id="commonColumnsNotPK">
		return_type
		, exception_order_id
		, order_id
		, flow_id
		, order_status
		, cust_name
		, cust_id
		, supply_name
		, supply_id
		, remark
		, order_money_total
		, order_money
		, create_user
		, create_time
		, update_user
		, update_time
		, order_create_time
		, return_desc
		, deliver_time
		, receive_time
		, buyer_deliver_time
		, seller_receive_time
		, review_time
	</sql>

	<sql id="commonProcessDateColumns">
		exception_id
		, return_type
		, exception_order_id
		, order_id
		, flow_id
		, order_status
		, cust_name
		, cust_id
		, supply_name
		, supply_id
		, remark
		, order_money_total
		, order_money
		, create_user
		, date_format(create_time, '%Y-%m-%d %H:%i:%s') create_time
		, update_user
		, date_format(update_time, '%Y-%m-%d %H:%i:%s') update_time
		, date_format(order_create_time, '%Y-%m-%d %H:%i:%s') order_create_time
		, return_desc
		, date_format(deliver_time, '%Y-%m-%d %H:%i:%s') deliver_time
		, date_format(receive_time, '%Y-%m-%d %H:%i:%s') receive_time
		, date_format(buyer_deliver_time, '%Y-%m-%d %H:%i:%s') buyer_deliver_time
		, date_format(seller_receive_time, '%Y-%m-%d %H:%i:%s') seller_receive_time
		, date_format(review_time, '%Y-%m-%d %H:%i:%s') review_time
	</sql>

	<sql id="T1commonProcessDateColumns">
		T1.exception_id
		, T1.return_type
		, T1.exception_order_id
		, T1.order_id
		, T1.flow_id
		, T1.order_status
		, T1.cust_name
		, T1.cust_id
		, T1.supply_name
		, T1.supply_id
		, T1.remark
		, T1.order_money_total
		, T1.order_money
		, T1.create_user
		, date_format(T1.create_time, '%Y-%m-%d %H:%i:%s') create_time
		, T1.update_user
		, date_format(T1.update_time, '%Y-%m-%d %H:%i:%s') update_time
		, date_format(T1.order_create_time, '%Y-%m-%d %H:%i:%s') order_create_time
		, T1.return_desc
		, date_format(T1.deliver_time, '%Y-%m-%d %H:%i:%s') deliver_time
		, date_format(T1.receive_time, '%Y-%m-%d %H:%i:%s') receive_time
		, date_format(T1.buyer_deliver_time, '%Y-%m-%d %H:%i:%s') buyer_deliver_time
		, date_format(T1.seller_receive_time, '%Y-%m-%d %H:%i:%s') seller_receive_time
		, date_format(T1.review_time, '%Y-%m-%d %H:%i:%s') review_time
	</sql>

	<sql id="commonCondition">
		<if test="exceptionId!= null and exceptionId!= ''">
			AND exception_id=#{exceptionId}
		</if>
		<if test="returnType!= null and returnType!= ''">
			AND return_type=#{returnType}
		</if>
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND exception_order_id=#{exceptionOrderId}
		</if>
		<if test="orderId!= null and orderId!= ''">
			AND order_id=#{orderId}
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND flow_id=#{flowId}
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			AND order_status=#{orderStatus}
		</if>
		<if test="custName!= null and custName!= ''">
			AND cust_name=#{custName}
		</if>
		<if test="custId!= null and custId!= ''">
			AND cust_id=#{custId}
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND supply_name=#{supplyName}
		</if>
		<if test="supplyId!= null and supplyId!= ''">
			AND supply_id=#{supplyId}
		</if>
		<if test="remark!= null and remark!= ''">
			AND remark=#{remark}
		</if>
		<if test="orderMoneyTotal!= null and orderMoneyTotal!= ''">
			AND order_money_total=#{orderMoneyTotal}
		</if>
		<if test="orderMoney!= null and orderMoney!= ''">
			AND order_money=#{orderMoney}
		</if>
		<if test="createUser!= null and createUser!= ''">
			AND create_user=#{createUser}
		</if>
		<if test="createTime!= null and createTime!= ''">
			AND create_time=str_to_date(#{createTime},'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="updateUser!= null and updateUser!= ''">
			AND update_user=#{updateUser}
		</if>
		<if test="updateTime!= null and updateTime!= ''">
			AND update_time=str_to_date(#{updateTime},'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="orderCreateTime!= null and orderCreateTime!= ''">
			AND order_create_time=str_to_date(#{orderCreateTime},'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="returnDesc!= null and returnDesc!= ''">
			AND return_desc=#{returnDesc}
		</if>
		<if test="deliverTime!= null and deliverTime!= ''">
			AND deliver_time=str_to_date(#{deliverTime},'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="receiveTime!= null and receiveTime!= ''">
			AND receive_time=str_to_date(#{receiveTime},'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="buyerDeliverTime!= null and buyerDeliverTime!= ''">
			AND buyer_deliver_time=str_to_date(#{buyerDeliverTime},'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="sellerReceiveTime!= null and sellerReceiveTime!= ''">
			AND seller_receive_time=str_to_date(#{sellerReceiveTime},'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="reviewTime!= null and reviewTime!= ''">
			AND review_time=str_to_date(#{reviewTime},'%Y-%m-%d %H:%i:%s')
		</if>
	</sql>

	<insert id="save" parameterType="OrderException">
		<![CDATA[ INSERT INTO t_order_exception ( ]]>
		<include refid="commonColumnsNotPK"/>
		<![CDATA[
			) VALUES (
				 #{returnType}
				, #{exceptionOrderId}
				, #{orderId}
				, #{flowId}
				, #{orderStatus}
				, #{custName}
				, #{custId}
				, #{supplyName}
				, #{supplyId}
				, #{remark}
				, #{orderMoneyTotal}
				, #{orderMoney}
				, #{createUser}
				, str_to_date(#{createTime},'%Y-%m-%d %H:%i:%s')
				, #{updateUser}
				, str_to_date(#{updateTime},'%Y-%m-%d %H:%i:%s')
				, str_to_date(#{orderCreateTime},'%Y-%m-%d %H:%i:%s')
				, #{returnDesc}
				, str_to_date(#{deliverTime},'%Y-%m-%d %H:%i:%s')
				, str_to_date(#{receiveTime},'%Y-%m-%d %H:%i:%s')
				, str_to_date(#{buyerDeliverTime},'%Y-%m-%d %H:%i:%s')
				, str_to_date(#{sellerReceiveTime},'%Y-%m-%d %H:%i:%s')
				, str_to_date(#{reviewTime},'%Y-%m-%d %H:%i:%s')
  ) ]]>
	</insert>
	<update id="update" parameterType="OrderException">
		<![CDATA[ UPDATE t_order_exception SET
			 exception_id=#{exceptionId}
			, return_type=#{returnType}
			, exception_order_id=#{exceptionOrderId}
			, order_id=#{orderId}
			, flow_id=#{flowId}
			, order_status=#{orderStatus}
			, cust_name=#{custName}
			, cust_id=#{custId}
			, supply_name=#{supplyName}
			, supply_id=#{supplyId}
			, remark=#{remark}
			, order_money_total=#{orderMoneyTotal}
			, order_money=#{orderMoney}
			, create_user=#{createUser}
			, create_time=str_to_date(#{createTime},'%Y-%m-%d %H:%i:%s')
			, update_user=#{updateUser}
			, update_time=str_to_date(#{updateTime},'%Y-%m-%d %H:%i:%s')
			, order_create_time=str_to_date(#{orderCreateTime},'%Y-%m-%d %H:%i:%s')
			, return_desc=#{returnDesc}
			, deliver_time=str_to_date(#{deliverTime},'%Y-%m-%d %H:%i:%s')
			, receive_time=str_to_date(#{receiveTime},'%Y-%m-%d %H:%i:%s')
			, buyer_deliver_time=str_to_date(#{buyerDeliverTime},'%Y-%m-%d %H:%i:%s')
			, seller_receive_time=str_to_date(#{sellerReceiveTime},'%Y-%m-%d %H:%i:%s')
			, review_time=str_to_date(#{reviewTime},'%Y-%m-%d %H:%i:%s')
		WHERE exception_id = #{exceptionId}  ]]>
	</update>
	<update id="updateOrderStatus" parameterType="OrderException">
		<![CDATA[ UPDATE t_order_exception SET order_status=#{orderStatus} WHERE exception_id = #{exceptionId} AND  cust_id=#{custId} ]]>
	</update>
	<delete id="deleteByPK" parameterType="java.lang.Integer">
		<![CDATA[ DELETE FROM t_order_exception WHERE exception_id = #{exceptionId}  ]]>
	</delete>
	<delete id="deleteByPKeys" parameterType="map">
		DELETE FROM t_order_exception WHERE
		<foreach collection="primaryKeys" index="index" item="id"
				 open=" exception_id IN(" separator="," close=") ">
			${id}
		</foreach>
	</delete>
	<delete id="deleteByProperty" parameterType="OrderException">
		DELETE FROM t_order_exception WHERE 1 = 1
		<include refid="commonCondition"/>
	</delete>
	<select id="getByPK" parameterType="java.lang.Integer" resultMap="OrderExceptionResultMapper">
		<![CDATA[ SELECT ]]>
		<include refid="commonProcessDateColumns"/>
		FROM t_order_exception WHERE exception_id = #{exceptionId}
	</select>
	<select id="list" resultMap="OrderExceptionResultMapper">
		<![CDATA[ SELECT ]]>
		<include refid="commonProcessDateColumns"/>
		FROM t_order_exception
	</select>
	<select id="listByProperty" parameterType="OrderException" resultMap="OrderExceptionResultMapper">
		<![CDATA[ SELECT ]]>
		<include refid="commonProcessDateColumns"/>
		FROM t_order_exception WHERE 1=1
		<include refid="commonCondition"/>
	</select>
	<select id="listPaginationByProperty" parameterType="OrderException" resultMap="OrderExceptionResultMapper">
		SELECT
		<include refid="commonProcessDateColumns"/>
		FROM t_order_exception WHERE 1=1
		<include refid="commonCondition"/>
	</select>
	<select id="findByCount" parameterType="OrderException" resultType="int">
		SELECT count(1) AS totalcount FROM t_order_exception WHERE 1=1
		<include refid="commonCondition"/>
	</select>

	<resultMap id="OrderExceptionDetailsResultMap" type="OrderExceptionDto" extends="OrderExceptionResultMapper">
		<result column="PAY_TYPE" property="payType"/>
		<result column="PAY_TYPE_NAME" property="payTypeName"/>
		<result column="bill_type" property="billType"/>
		<association property="orderDelivery" column="flow_id" select="com.yyw.yhyc.order.mapper.OrderDeliveryMapper.getByFlowId"></association>
		<collection property="orderReturnList" column="exception_order_id" select="com.yyw.yhyc.order.mapper.OrderReturnMapper.getByExceptionOrderId"/>
	</resultMap>

	<select id="getOrderExceptionDetails" parameterType="OrderExceptionDto"  resultMap="OrderExceptionDetailsResultMap">
		SELECT
		<include refid="T1commonProcessDateColumns"/>,T2.bill_type,T3.PAY_TYPE,T3.PAY_TYPE_NAME
		FROM
		t_order_exception T1
		LEFT JOIN t_order T2 ON T1.order_id=T2.order_id
		LEFT JOIN t_system_pay_type T3 ON T2.pay_type_id = T3.pay_type_id
		WHERE 1=1
		<if test="flowId!= null and flowId!= ''">
			AND T1.flow_id=#{flowId}
		</if>
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.exception_order_id=#{exceptionOrderId}
		</if>
		<if test="returnType!= null and returnType!= ''">
			AND T1.return_type=#{returnType}
		</if>
		<if test="!(returnType!= null and returnType!= '')">
			AND T1.return_type='4'
		</if>
		<if test="custId!= null and custId!= ''">
			AND T1.cust_Id=#{custId}
		</if>
		<if test="supplyId!= null and supplyId!= ''">
			AND T1.supply_id=#{supplyId}
		</if>
	</select>


	<resultMap id="buyerRejectOrderResultMap" type="OrderExceptionDto" extends="OrderExceptionResultMapper">
		<result column="PAY_TYPE" property="payType"/>
		<result column="PAY_TYPE_NAME" property="payTypeName"/>
	</resultMap>
	<select id="listPaginationBuyerRejectOrder" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap">
		SELECT
		<include refid="T1commonProcessDateColumns"/>, T3.PAY_TYPE,
			T3.PAY_TYPE_NAME
		FROM
			T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
			T1.RETURN_TYPE = '4'
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--拒收申请中-->
				</when>
				<when test='orderStatus == "4"'><!--已完成-->
					AND (
						(T1.ORDER_STATUS = '2' AND (T3.PAY_TYPE = 1 OR T3.PAY_TYPE = 2)) OR
						(T1.ORDER_STATUS = '4' AND T3.PAY_TYPE = 3)
					)<!--卖家已确认+（在线支付 or 账期支付）  或者 已退款+线下支付-->
				</when>
				<when test='orderStatus == "2"'><!--退款中-->
					AND T1.ORDER_STATUS = '2' AND T3.PAY_TYPE = 3 <!--卖家已确认+线下支付-->
				</when>
				<when test='orderStatus == "3"'><!--已关闭-->
					AND T1.ORDER_STATUS = '3' <!--卖家已关闭-->
				</when>
				<otherwise>
					AND T1.EXCEPTION_ID IS NULL
				</otherwise>
			</choose>
		</if>
		ORDER BY T1.EXCEPTION_ID DESC
	</select>
	<select id="findBuyerExceptionOrderTotal" parameterType="OrderExceptionDto" resultType="java.math.BigDecimal">
		SELECT
		SUM(ORDER_MONEY)
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
		T1.RETURN_TYPE = '4'

		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--拒收申请中-->
				</when>
				<when test='orderStatus == "4"'><!--已完成-->
					AND (
					(T1.ORDER_STATUS = '2' AND (T3.PAY_TYPE = 1 OR T3.PAY_TYPE = 2)) OR
					(T1.ORDER_STATUS = '4' AND T3.PAY_TYPE = 3)
					)<!--卖家已确认+（在线支付 or 账期支付）  或者 已退款+线下支付-->
				</when>
				<when test='orderStatus == "2"'><!--退款中-->
					AND T1.ORDER_STATUS = '2' AND T3.PAY_TYPE = 3 <!--卖家已确认+线下支付-->
				</when>
				<when test='orderStatus == "3"'><!--已关闭-->
					AND T1.ORDER_STATUS = '3' <!--卖家已关闭-->
				</when>
				<otherwise>
					AND T1.EXCEPTION_ID IS NULL
				</otherwise>
			</choose>
		</if>
		AND T1.ORDER_MONEY IS NOT NULL
	</select>
	<select id="findBuyerRejectOrderStatusCount" parameterType="OrderExceptionDto" resultType="OrderExceptionDto">
		SELECT
		T1.ORDER_STATUS AS orderStatus,COUNT(T1.ORDER_STATUS) AS orderCount,T3.PAY_TYPE AS payType
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
		T1.RETURN_TYPE = '4'
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		GROUP BY T1.ORDER_STATUS,T3.PAY_TYPE
	</select>

	<resultMap id="OrderExceptionlistResultMap" type="OrderExceptionDto" extends="OrderExceptionResultMapper">
		<result column="PAY_TYPE" property="payType"/>
		<result column="PAY_TYPE_NAME" property="payTypeName"/>
	</resultMap>

	<select id="listPaginationSellerByProperty" parameterType="OrderExceptionDto"  resultMap="OrderExceptionlistResultMap">

		SELECT e.*,t.pay_type,t.pay_type_name FROM t_order_exception  e

		INNER JOIN t_order o ON e.order_id = o.order_id

		INNER JOIN t_system_pay_type t ON o.pay_type_id = t.pay_type_id

		LEFT JOIN t_passport_user u ON u.id = e.cust_id
		LEFT JOIN t_usermanage_enterprise ue ON u.enterprise_id = ue.enterprise_id

		WHERE e.return_type = '4'

		<if test="custId !=null and custId !=''">
			AND e.cust_id = #{custId}
		</if>
		<if test="supplyId !=null and supplyId !=''">
			AND e.supply_id = #{supplyId}
		</if>
		<if test="flowId !=null and flowId !=''">
			AND e.flow_id = #{flowId}
		</if>

		<if test="custName !=null and custName !=''">
			AND e.cust_name LIKE CONCAT('%',#{custName},'%')
		</if>

		<if test="startTime !=null and startTime!=''">
			AND e.create_time > #{startTime}
		</if>
		<if test="endTime !=null and endTime!=''">
			AND #{endTime} > e.create_time
		</if>
		<if test="type!= null and type!= ''">
			<choose>
				<when test='type == "2"'><!--待确认-->
					AND e.ORDER_STATUS = '1' <!--拒收申请中-->
				</when>
				<when test='type == "3"'><!--退款中--><!--卖家已确认+线下支付/线下转账-->
					AND e.ORDER_STATUS = '2'  AND (t.PAY_TYPE = 1 or t.PAY_TYPE = 3)
				</when>
				<when test='type == "4"'><!--已完成  退款+在线/线下 or 卖家确认+账期-->
					AND (( e.ORDER_STATUS = '2'  AND  t.PAY_TYPE = 2 )
					OR  (e.ORDER_STATUS = '4'  AND  (t.PAY_TYPE = 1 OR t.pay_type = 3))
					)
				</when>
				<when test='type == "5"'><!--已关闭-->
					AND e.ORDER_STATUS = '3' <!--卖家已关闭-->
				</when>
				<otherwise>

				</otherwise>
			</choose>
		</if>

		<if test="province !=null and province != '' and province != '-1' ">
			AND ue.province = #{province}
		</if>
		<if test="city !=null and city != '' and city != '-1'">
			AND ue.city = #{city}
		</if>
		<if test="area !=null and area != '' and area !='-1'">
			AND ue.district = #{area}
		</if>
	</select>

	<select id="findSellerExceptionOrderTotal" parameterType="OrderExceptionDto" resultType="java.math.BigDecimal">

		SELECT SUM(ORDER_MONEY)

		FROM t_order_exception  e

		INNER JOIN t_order o ON e.order_id = o.order_id

		INNER JOIN t_system_pay_type t ON o.pay_type_id = t.pay_type_id

		LEFT JOIN t_passport_user u ON u.id = e.cust_id
		LEFT JOIN t_usermanage_enterprise ue ON u.enterprise_id = ue.enterprise_id

		WHERE e.return_type = '4'

		<if test="custId !=null and custId !=''">
			AND e.cust_id = #{custId}
		</if>
		<if test="supplyId !=null and supplyId !=''">
			AND e.supply_id = #{supplyId}
		</if>
		<if test="flowId !=null and flowId !=''">
			AND e.flow_id = #{flowId}
		</if>

		<if test="custName !=null and custName !=''">
			AND e.cust_name LIKE CONCAT('%',#{custName},'%')
		</if>

		<if test="startTime !=null and startTime!=''">
			AND e.create_time > #{startTime}
		</if>
		<if test="endTime !=null and endTime!=''">
			AND #{endTime} > e.create_time
		</if>
		<if test="type!= null and type!= ''">
			<choose>
				<when test='type == "2"'><!--待确认-->
					AND e.ORDER_STATUS = '1' <!--拒收申请中-->
				</when>
				<when test='type == "3"'><!--退款中--><!--卖家已确认+线下支付/线下转账-->
					AND e.ORDER_STATUS = '2'  AND (t.PAY_TYPE = 1 or t.PAY_TYPE = 3)
				</when>
				<when test='type == "4"'><!--已完成  退款+在线/线下 or 卖家确认+账期-->
					AND (( e.ORDER_STATUS = '2'  AND  t.PAY_TYPE = 2 )
					OR  (e.ORDER_STATUS = '4'  AND  (t.PAY_TYPE = 1 OR t.pay_type = 3))
					)
				</when>
				<when test='type == "5"'><!--已关闭-->
					AND e.ORDER_STATUS = '3' <!--卖家已关闭-->
				</when>
				<otherwise>

				</otherwise>
			</choose>
		</if>

		<if test="province !=null and province != '' and province != '-1' ">
			AND ue.province = #{province}
		</if>
		<if test="city !=null and city != '' and city != '-1'">
			AND ue.city = #{city}
		</if>
		<if test="area !=null and area != '' and area !='-1'">
			AND ue.district = #{area}
		</if>
	</select>
	<select id="findSellerRejectOrderStatusCount" parameterType="OrderExceptionDto" resultType="java.lang.Integer">

		SELECT count(0)

		FROM t_order_exception  e

		INNER JOIN t_order o ON e.order_id = o.order_id

		INNER JOIN t_system_pay_type t ON o.pay_type_id = t.pay_type_id

		LEFT JOIN t_passport_user u ON u.id = e.cust_id
		LEFT JOIN t_usermanage_enterprise ue ON u.enterprise_id = ue.enterprise_id

		WHERE e.return_type = '4'

		<if test="custId !=null and custId !=''">
			AND e.cust_id = #{custId}
		</if>
		<if test="supplyId !=null and supplyId !=''">
			AND e.supply_id = #{supplyId}
		</if>
		<if test="flowId !=null and flowId !=''">
			AND e.flow_id = #{flowId}
		</if>
		<if test="exceptionOrderId !=null and exceptionOrderId !=''">
			AND e.exception_order_id = #{exceptionOrderId}
		</if>

		<if test="custName !=null and custName !=''">
			AND e.cust_name LIKE CONCAT('%',#{custName},'%')
		</if>

		<if test="startTime !=null and startTime!=''">
			AND e.create_time > #{startTime}
		</if>
		<if test="endTime !=null and endTime!=''">
			AND #{endTime} > e.create_time
		</if>
		<if test="type!= null and type!= ''">
			<choose>
				<when test='type == "2"'><!--待确认-->
					AND e.ORDER_STATUS = '1' <!--拒收申请中-->
				</when>
				<when test='type == "3"'><!--退款中--><!--卖家已确认+线下支付/线下转账-->
					AND e.ORDER_STATUS = '2'  AND (t.PAY_TYPE = 1 or t.PAY_TYPE = 3)
				</when>
				<when test='type == "4"'><!--已完成  退款+在线/线下 or 卖家确认+账期-->
					AND (( e.ORDER_STATUS = '2'  AND  t.PAY_TYPE = 2 )
					OR  (e.ORDER_STATUS = '4'  AND  (t.PAY_TYPE = 1 OR t.pay_type = 3))
					)
				</when>
				<when test='type == "5"'><!--已关闭-->
					AND e.ORDER_STATUS = '3' <!--卖家已关闭-->
				</when>
				<otherwise>

				</otherwise>
			</choose>
		</if>

		<if test="province !=null and province != '' and province != '-1' ">
			AND ue.province = #{province}
		</if>
		<if test="city !=null and city != '' and city != '-1'">
			AND ue.city = #{city}
		</if>
		<if test="area !=null and area != '' and area !='-1'">
			AND ue.district = #{area}
		</if>
	</select>

	<select id="listPgBuyerChangeGoodsOrder" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap">
		SELECT
		<include refid="T1commonProcessDateColumns"/>, T3.PAY_TYPE,
		T3.PAY_TYPE_NAME
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
		T1.RETURN_TYPE = '2'
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			AND T1.ORDER_STATUS = #{orderStatus}
		</if>
		ORDER BY T1.EXCEPTION_ID DESC
	</select>

	<select id="findBuyerChangeGoodsExceptionOrderTotal" parameterType="OrderExceptionDto" resultType="java.math.BigDecimal">
		SELECT
		SUM(ORDER_MONEY)
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
		T1.RETURN_TYPE = '2'
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			AND T1.ORDER_STATUS = #{orderStatus}
		</if>
		AND T1.ORDER_MONEY IS NOT NULL
	</select>

	<select id="findBuyerChangeGoodsOrderStatusCount" parameterType="OrderExceptionDto" resultType="OrderExceptionDto">
		SELECT
		T1.ORDER_STATUS AS orderStatus,COUNT(T1.ORDER_STATUS) AS orderCount,T3.PAY_TYPE AS payType
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
		T1.RETURN_TYPE = '2'
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			AND T1.ORDER_STATUS = #{orderStatus}
		</if>
		GROUP BY T1.ORDER_STATUS,T3.PAY_TYPE
	</select>


	<select id="listPaginationBuyerReplenishmentOrder" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap"  useCache="false">
		SELECT
		<include refid="T1commonProcessDateColumns"/>, T3.PAY_TYPE,
		T3.PAY_TYPE_NAME
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
		T1.RETURN_TYPE = '3'<!--补货订单-->
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--买家已申请-->
				</when>
				<when test='orderStatus == "2"'><!--待发货-->
					AND T1.ORDER_STATUS = '2' <!--买家已申请-->
				</when>
				<when test='orderStatus == "4"'><!--已关闭-->
					AND T1.ORDER_STATUS = '3' <!--已关闭-->
				</when>
				<when test='orderStatus == "3"'><!--待收货-->
					AND T1.ORDER_STATUS = '4' <!--待收货-->
				</when>
				<when test='orderStatus == "5"'>
					AND (T1.ORDER_STATUS = '5' OR T1.ORDER_STATUS = '6') <!--买家已收货 + 系统自动确认收货-->
				</when>
				<otherwise>
					<![CDATA[ AND 1<>1]]>
				</otherwise>
			</choose>
		</if>
		ORDER BY T1.EXCEPTION_ID DESC
	</select>

	<select id="findBuyerReplenishmentOrderTotal" parameterType="OrderExceptionDto" resultType="java.math.BigDecimal"  useCache="false">
		SELECT
		SUM(T1.ORDER_MONEY)
		FROM
		T_ORDER_EXCEPTION T1
		WHERE
		T1.RETURN_TYPE = '3'<!--补货订单-->
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--买家已申请-->
				</when>
				<when test='orderStatus == "2"'><!--待发货-->
					AND T1.ORDER_STATUS = '2' <!--买家已申请-->
				</when>
				<when test='orderStatus == "4"'><!--已关闭-->
					AND T1.ORDER_STATUS = '3' <!--已关闭-->
				</when>
				<when test='orderStatus == "3"'><!--待收货-->
					AND T1.ORDER_STATUS = '4' <!--待收货-->
				</when>
				<when test='orderStatus == "5"'>
					AND (T1.ORDER_STATUS = '5' OR T1.ORDER_STATUS = '6') <!--买家已收货 + 系统自动确认收货-->
				</when>
				<otherwise>
					<![CDATA[ AND 1<>1]]>
				</otherwise>
			</choose>
		</if>
		AND T1.ORDER_MONEY IS NOT NULL
	</select>


	<select id="findBuyerReplenishmentStatusCount" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap" useCache="false">
		SELECT
		T1.ORDER_STATUS AS orderStatus,COUNT(T1.ORDER_STATUS) AS orderCount
		FROM
		T_ORDER_EXCEPTION T1
		WHERE
		T1.RETURN_TYPE = '3'<!--补货订单-->
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		GROUP BY T1.ORDER_STATUS
	</select>


	<select id="listPaginationSellerReplenishmentOrder" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap"  useCache="false">
		SELECT
		<include refid="T1commonProcessDateColumns"/>, T3.PAY_TYPE,
		T3.PAY_TYPE_NAME
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		LEFT JOIN t_passport_user u ON u.id = T1.cust_id
		LEFT JOIN t_usermanage_enterprise ue ON u.enterprise_id = ue.enterprise_id
		WHERE
		T1.RETURN_TYPE = '3'<!--补货订单-->
		<if test="custId !=null and custId !=''">
			AND T1.CUST_ID = #{custId}
		</if>
		<if test="supplyId !=null and supplyId !=''">
			AND T1.SUPPLY_ID = #{supplyId}
		</if>
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--买家已申请-->
				</when>
				<when test='orderStatus == "2"'><!--待发货-->
					AND T1.ORDER_STATUS = '2' <!--买家已申请-->
				</when>
				<when test='orderStatus == "4"'><!--已关闭-->
					AND T1.ORDER_STATUS = '3' <!--已关闭-->
				</when>
				<when test='orderStatus == "3"'><!--待收货-->
					AND T1.ORDER_STATUS = '4' <!--待收货-->
				</when>
				<when test='orderStatus == "5"'>
					AND (T1.ORDER_STATUS = '5' OR T1.ORDER_STATUS = '6') <!--买家已收货 + 系统自动确认收货-->
				</when>
				<otherwise>
					<![CDATA[ AND 1<>1]]>
				</otherwise>
			</choose>
		</if>
		<if test="province !=null and province != '' and province != '-1' ">
			AND ue.province = #{province}
		</if>
		<if test="city !=null and city != '' and city != '-1'">
			AND ue.city = #{city}
		</if>
		<if test="area !=null and area != '' and area !='-1'">
			AND ue.district = #{area}
		</if>
		ORDER BY T1.EXCEPTION_ID DESC
	</select>

	<select id="findSellerReplenishmentOrderTotal" parameterType="OrderExceptionDto" resultType="java.math.BigDecimal"  useCache="false">
		SELECT
		SUM(T1.ORDER_MONEY)
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN t_passport_user u ON u.id = T1.cust_id
		LEFT JOIN t_usermanage_enterprise ue ON u.enterprise_id = ue.enterprise_id
		WHERE
		T1.RETURN_TYPE = '3'<!--补货订单-->
		<if test="custId !=null and custId !=''">
			AND T1.CUST_ID = #{custId}
		</if>
		<if test="supplyId !=null and supplyId !=''">
			AND T1.SUPPLY_ID = #{supplyId}
		</if>
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--买家已申请-->
				</when>
				<when test='orderStatus == "2"'><!--待发货-->
					AND T1.ORDER_STATUS = '2' <!--买家已申请-->
				</when>
				<when test='orderStatus == "4"'><!--已关闭-->
					AND T1.ORDER_STATUS = '3' <!--已关闭-->
				</when>
				<when test='orderStatus == "3"'><!--待收货-->
					AND T1.ORDER_STATUS = '4' <!--待收货-->
				</when>
				<when test='orderStatus == "5"'>
					AND (T1.ORDER_STATUS = '5' OR T1.ORDER_STATUS = '6') <!--买家已收货 + 系统自动确认收货-->
				</when>
				<otherwise>
					<![CDATA[ AND 1<>1]]>
				</otherwise>
			</choose>
		</if>
		<if test="province !=null and province != '' and province != '-1' ">
			AND ue.province = #{province}
		</if>
		<if test="city !=null and city != '' and city != '-1'">
			AND ue.city = #{city}
		</if>
		<if test="area !=null and area != '' and area !='-1'">
			AND ue.district = #{area}
		</if>
		AND T1.ORDER_MONEY IS NOT NULL
	</select>


	<select id="findSellerReplenishmentStatusCount" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap" useCache="false">
		SELECT
		T1.ORDER_STATUS AS orderStatus,COUNT(T1.ORDER_STATUS) AS orderCount
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN t_passport_user u ON u.id = T1.cust_id
		LEFT JOIN t_usermanage_enterprise ue ON u.enterprise_id = ue.enterprise_id
		WHERE
		T1.RETURN_TYPE = '3'<!--补货订单-->
		<if test="custId !=null and custId !=''">
			AND T1.CUST_ID = #{custId}
		</if>
		<if test="supplyId !=null and supplyId !=''">
			AND T1.SUPPLY_ID = #{supplyId}
		</if>
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="province !=null and province != '' and province != '-1' ">
			AND ue.province = #{province}
		</if>
		<if test="city !=null and city != '' and city != '-1'">
			AND ue.city = #{city}
		</if>
		<if test="area !=null and area != '' and area !='-1'">
			AND ue.district = #{area}
		</if>
		GROUP BY T1.ORDER_STATUS
	</select>

	<select id="listPgSellerChangeGoodsOrder" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap">
		SELECT
		<include refid="T1commonProcessDateColumns"/>, T3.PAY_TYPE,
		T3.PAY_TYPE_NAME
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		LEFT JOIN t_passport_user u ON u.id = T1.cust_id
		LEFT JOIN t_usermanage_enterprise ue ON u.enterprise_id = ue.enterprise_id
		WHERE
		T1.RETURN_TYPE = '2'
		AND	T1.supply_id = #{supplyId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			AND T1.ORDER_STATUS = #{orderStatus}
		</if>
		<if test="province !=null and province != '' and province != '-1' ">
			AND ue.province = #{province}
		</if>
		<if test="city !=null and city != '' and city != '-1'">
			AND ue.city = #{city}
		</if>
		<if test="area !=null and area != '' and area !='-1'">
			AND ue.district = #{area}
		</if>
		ORDER BY T1.EXCEPTION_ID DESC
	</select>

	<select id="findSellerChangeGoodsExceptionOrderTotal" parameterType="OrderExceptionDto" resultType="java.math.BigDecimal">
		SELECT
		SUM(ORDER_MONEY)
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		LEFT JOIN t_passport_user u ON u.id = T1.cust_id
		LEFT JOIN t_usermanage_enterprise ue ON u.enterprise_id = ue.enterprise_id
		WHERE
		T1.RETURN_TYPE = '2'
		AND	T1.supply_id = #{supplyId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			AND T1.ORDER_STATUS = #{orderStatus}
		</if>
		<if test="province !=null and province != '' and province != '-1' ">
			AND ue.province = #{province}
		</if>
		<if test="city !=null and city != '' and city != '-1'">
			AND ue.city = #{city}
		</if>
		<if test="area !=null and area != '' and area !='-1'">
			AND ue.district = #{area}
		</if>
		AND T1.ORDER_MONEY IS NOT NULL
	</select>

	<select id="findSellerChangeGoodsOrderStatusCount" parameterType="OrderExceptionDto" resultType="OrderExceptionDto">
		SELECT
		T1.ORDER_STATUS AS orderStatus,COUNT(T1.ORDER_STATUS) AS orderCount,T3.PAY_TYPE AS payType
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		LEFT JOIN t_passport_user u ON u.id = T1.cust_id
		LEFT JOIN t_usermanage_enterprise ue ON u.enterprise_id = ue.enterprise_id
		WHERE
		T1.RETURN_TYPE = '2'
		AND	T1.supply_id = #{supplyId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			AND T1.ORDER_STATUS = #{orderStatus}
		</if>
		<if test="province !=null and province != '' and province != '-1' ">
			AND ue.province = #{province}
		</if>
		<if test="city !=null and city != '' and city != '-1'">
			AND ue.city = #{city}
		</if>
		<if test="area !=null and area != '' and area !='-1'">
			AND ue.district = #{area}
		</if>
		GROUP BY T1.ORDER_STATUS,T3.PAY_TYPE
	</select>

	<!--补货订单详情-->
	<resultMap id="replenishmentDetailsResultMap" type="OrderExceptionDto" extends="OrderExceptionResultMapper">
		<result column="PAY_TYPE" property="payType"/>
		<result column="PAY_TYPE_NAME" property="payTypeName"/>
		<result column="bill_type" property="billType"/>
		<association property="orderDelivery" column="exception_order_id" select="com.yyw.yhyc.order.mapper.OrderDeliveryMapper.getByFlowId"></association>
		<collection property="orderReturnList" column="exception_order_id" select="com.yyw.yhyc.order.mapper.OrderReturnMapper.getByExceptionOrderId"/>
	</resultMap>

	<select id="getReplenishmentDetails" parameterType="OrderExceptionDto"  resultMap="replenishmentDetailsResultMap">
		SELECT
		<include refid="T1commonProcessDateColumns"/>,T2.bill_type,T3.PAY_TYPE,T3.PAY_TYPE_NAME
		FROM
		t_order_exception T1
		LEFT JOIN t_order T2 ON T1.order_id=T2.order_id
		LEFT JOIN t_system_pay_type T3 ON T2.pay_type_id = T3.pay_type_id
		WHERE T1.flow_id=#{flowId} AND return_type='3'
		<if test="custId!= null and custId!= ''">
			AND T1.cust_Id=#{custId}
		</if>
		<if test="supplyId!= null and supplyId!= ''">
			AND T1.supply_id=#{supplyId}
		</if>
	</select>

	<select id="listPaginationBuyerRefundOrder" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap"  useCache="false">
		SELECT
		<include refid="T1commonProcessDateColumns"/>, T3.PAY_TYPE,
		T3.PAY_TYPE_NAME
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
		T1.RETURN_TYPE = '1'<!--退货-->
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--买家已申请-->
				</when>
				<when test='orderStatus == "2"'><!--已取消-->
					AND T1.ORDER_STATUS = '2' <!--买家已取消-->
				</when>
				<when test='orderStatus == "3"'><!--待买家发货-->
					AND T1.ORDER_STATUS = '3' <!--卖家已确认-->
				</when>
				<when test='orderStatus == "4"'><!--已关闭-->
					AND T1.ORDER_STATUS = '4' <!--卖家已关闭-->
				</when>
				<when test='orderStatus == "5"'><!--待卖家收货-->
					AND T1.ORDER_STATUS = '5' <!--买家已发货-->
				</when>
				<when test='orderStatus == "6"'><!--退款中-->
					AND ((T1.ORDER_STATUS = '6' OR T1.ORDER_STATUS = '7') AND (T3.PAY_TYPE = 1 OR T3.PAY_TYPE = 3))<!--(卖家已收货、系统自动确认收货)+(在线支付、线下转账)-->
				</when>
				<when test='orderStatus == "7"'><!--已完成-->
					AND (
					(
					(T1.ORDER_STATUS = '6' OR T1.ORDER_STATUS = '7')
					AND T3.PAY_TYPE = 2
					)<!--(卖家已收货、系统自动确认收货)+账期支付-->
					OR T1.ORDER_STATUS = '8'<!--已退款-->
					)
				</when>
				<otherwise>
					<![CDATA[ AND 1<>1]]>
				</otherwise>
			</choose>
		</if>
		ORDER BY T1.EXCEPTION_ID DESC
	</select>

	<select id="findBuyerRefundOrderTotal" parameterType="OrderExceptionDto" resultType="java.math.BigDecimal"  useCache="false">
		SELECT
		SUM(T1.ORDER_MONEY)
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
		T1.RETURN_TYPE = '1'<!--退货-->
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--买家已申请-->
				</when>
				<when test='orderStatus == "2"'><!--已取消-->
					AND T1.ORDER_STATUS = '2' <!--买家已取消-->
				</when>
				<when test='orderStatus == "3"'><!--待买家发货-->
					AND T1.ORDER_STATUS = '3' <!--卖家已确认-->
				</when>
				<when test='orderStatus == "4"'><!--已关闭-->
					AND T1.ORDER_STATUS = '4' <!--卖家已关闭-->
				</when>
				<when test='orderStatus == "5"'><!--待卖家收货-->
					AND T1.ORDER_STATUS = '5' <!--买家已发货-->
				</when>
				<when test='orderStatus == "6"'><!--退款中-->
					AND ((T1.ORDER_STATUS = '6' OR T1.ORDER_STATUS = '7') AND (T3.PAY_TYPE = 1 OR T3.PAY_TYPE = 3))<!--(卖家已收货、系统自动确认收货)+(在线支付、线下转账)-->
				</when>
				<when test='orderStatus == "7"'><!--已完成-->
					AND (
					(
					(T1.ORDER_STATUS = '6' OR T1.ORDER_STATUS = '7')
					AND T3.PAY_TYPE = 2
					)<!--(卖家已收货、系统自动确认收货)+账期支付-->
					OR T1.ORDER_STATUS = '8'<!--已退款-->
					)
				</when>
				<otherwise>
					<![CDATA[ AND 1<>1]]>
				</otherwise>
			</choose>
		</if>
	</select>

	<select id="findBuyerRefundOrderStatusCount" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap"  useCache="false">
		SELECT
		T1.ORDER_STATUS AS orderStatus,COUNT(T1.ORDER_STATUS) AS orderCount,T3.PAY_TYPE AS payType
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		WHERE
		T1.RETURN_TYPE = '1'<!--退货-->
		AND	T1.CUST_ID = #{custId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="supplyName!= null and supplyName!= ''">
			AND T1.SUPPLY_NAME LIKE CONCAT('%',#{supplyName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		GROUP BY T1.ORDER_STATUS,T3.PAY_TYPE
	</select>

	<select id="getOrderExceptionDetailsForReview" parameterType="OrderExceptionDto"  resultMap="OrderExceptionDetailsResultMap">
		SELECT
		T1.*,T2.bill_type,T3.PAY_TYPE,T3.PAY_TYPE_NAME
		FROM
		t_order_exception T1
		LEFT JOIN t_order T2 ON T1.order_id=T2.order_id
		LEFT JOIN t_system_pay_type T3 ON T2.pay_type_id = T3.pay_type_id
		WHERE T1.exception_id=#{exceptionId}
		<if test="custId!= null and custId!= ''">
			AND T1.cust_Id=#{custId}
		</if>
		<if test="supplyId!= null and supplyId!= ''">
			AND T1.supply_id=#{supplyId}
		</if>
	</select>

	<resultMap id="OrderExceptionDetailsReturnResultMap" type="OrderExceptionDto" extends="OrderExceptionResultMapper">
		<result column="PAY_TYPE" property="payType"/>
		<result column="PAY_TYPE_NAME" property="payTypeName"/>
		<association property="order" column="order_id" select="com.yyw.yhyc.order.mapper.OrderMapper.getByPK"></association>
		<association property="orderDelivery" column="exception_order_id" select="com.yyw.yhyc.order.mapper.OrderDeliveryMapper.getByFlowId"></association>
		<association property="usermanageEnterprise" column="supply_id" select="com.yyw.yhyc.usermanage.mapper.UsermanageEnterpriseMapper.getByEnterpriseId"></association>
		<collection property="orderReturnList" column="exception_order_id" select="com.yyw.yhyc.order.mapper.OrderReturnMapper.getByExceptionOrderId"/>
	</resultMap>

	<select id="getOrderExceptionDetailsForReturn" parameterType="OrderExceptionDto"  resultMap="OrderExceptionDetailsReturnResultMap">
		SELECT
		T1.*,T2.bill_type,T3.PAY_TYPE,T3.PAY_TYPE_NAME
		FROM
		t_order_exception T1
		LEFT JOIN t_order T2 ON T1.order_id=T2.order_id
		LEFT JOIN t_system_pay_type T3 ON T2.pay_type_id = T3.pay_type_id
		WHERE T1.exception_id=#{exceptionId}
		<if test="custId!= null and custId!= ''">
			AND T1.cust_Id=#{custId}
		</if>
		<if test="supplyId!= null and supplyId!= ''">
			AND T1.supply_id=#{supplyId}
		</if>
	</select>

	<select id="getByExceptionOrderId" parameterType="java.lang.String" resultMap="OrderExceptionResultMapper">
		<![CDATA[ SELECT ]]>
		<include refid="commonProcessDateColumns"/>
		FROM t_order_exception WHERE exception_order_id = #{exceptionOrderId}
	</select>


	<select id="listPaginationSellerRefundOrder" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap"  useCache="false">
		SELECT
		<include refid="T1commonProcessDateColumns"/>, T3.PAY_TYPE,
		T3.PAY_TYPE_NAME
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		LEFT JOIN T_USERMANAGE_ENTERPRISE T4 ON T1.CUST_ID = T4.ENTERPRISE_ID
		WHERE
		T1.RETURN_TYPE = '1'<!--退货-->
		AND	T1.SUPPLY_ID = #{supplyId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="custName!= null and custName!= ''">
			AND T1.CUST_NAME LIKE CONCAT('%',#{custName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="province !=null and province != '' ">
			AND T4.PROVINCE = #{province}
		</if>
		<if test="city !=null and city != ''">
			AND T4.CITY = #{city}
		</if>
		<if test="area !=null and area != ''">
			AND T4.DISTRICT = #{area}
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--买家已申请-->
				</when>
				<when test='orderStatus == "2"'><!--已取消-->
					AND T1.ORDER_STATUS = '2' <!--买家已取消-->
				</when>
				<when test='orderStatus == "3"'><!--待买家发货-->
					AND T1.ORDER_STATUS = '3' <!--卖家已确认-->
				</when>
				<when test='orderStatus == "4"'><!--已关闭-->
					AND T1.ORDER_STATUS = '4' <!--卖家已关闭-->
				</when>
				<when test='orderStatus == "5"'><!--待卖家收货-->
					AND T1.ORDER_STATUS = '5' <!--买家已发货-->
				</when>
				<when test='orderStatus == "6"'><!--退款中-->
					AND ((T1.ORDER_STATUS = '6' OR T1.ORDER_STATUS = '7') AND (T3.PAY_TYPE = 1 OR T3.PAY_TYPE = 3))<!--(卖家已收货、系统自动确认收货)+(在线支付、线下转账)-->
				</when>
				<when test='orderStatus == "7"'><!--已完成-->
					AND (
					(
					(T1.ORDER_STATUS = '6' OR T1.ORDER_STATUS = '7')
					AND T3.PAY_TYPE = 2
					)<!--(卖家已收货、系统自动确认收货)+账期支付-->
					OR T1.ORDER_STATUS = '8'<!--已退款-->
					)
				</when>
				<otherwise>
					<![CDATA[ AND 1<>1]]>
				</otherwise>
			</choose>
		</if>
		ORDER BY T1.EXCEPTION_ID DESC
	</select>


	<select id="findSellerRefundOrderTotal" parameterType="OrderExceptionDto" resultType="java.math.BigDecimal"  useCache="false">
		SELECT
		SUM(T1.ORDER_MONEY)
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		LEFT JOIN T_USERMANAGE_ENTERPRISE T4 ON T1.CUST_ID = T4.ENTERPRISE_ID
		WHERE
		T1.RETURN_TYPE = '1'<!--退货-->
		AND	T1.SUPPLY_ID = #{supplyId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="custName!= null and custName!= ''">
			AND T1.CUST_NAME LIKE CONCAT('%',#{custName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="province !=null and province != '' ">
			AND T4.PROVINCE = #{province}
		</if>
		<if test="city !=null and city != ''">
			AND T4.CITY = #{city}
		</if>
		<if test="area !=null and area != ''">
			AND T4.DISTRICT = #{area}
		</if>
		<if test="orderStatus!= null and orderStatus!= ''">
			<choose>
				<when test='orderStatus == "1"'><!--待确认-->
					AND T1.ORDER_STATUS = '1' <!--买家已申请-->
				</when>
				<when test='orderStatus == "2"'><!--已取消-->
					AND T1.ORDER_STATUS = '2' <!--买家已取消-->
				</when>
				<when test='orderStatus == "3"'><!--待买家发货-->
					AND T1.ORDER_STATUS = '3' <!--卖家已确认-->
				</when>
				<when test='orderStatus == "4"'><!--已关闭-->
					AND T1.ORDER_STATUS = '4' <!--卖家已关闭-->
				</when>
				<when test='orderStatus == "5"'><!--待卖家收货-->
					AND T1.ORDER_STATUS = '5' <!--买家已发货-->
				</when>
				<when test='orderStatus == "6"'><!--退款中-->
					AND ((T1.ORDER_STATUS = '6' OR T1.ORDER_STATUS = '7') AND (T3.PAY_TYPE = 1 OR T3.PAY_TYPE = 3))<!--(卖家已收货、系统自动确认收货)+(在线支付、线下转账)-->
				</when>
				<when test='orderStatus == "7"'><!--已完成-->
					AND (
					(
					(T1.ORDER_STATUS = '6' OR T1.ORDER_STATUS = '7')
					AND T3.PAY_TYPE = 2
					)<!--(卖家已收货、系统自动确认收货)+账期支付-->
					OR T1.ORDER_STATUS = '8'<!--已退款-->
					)
				</when>
				<otherwise>
					<![CDATA[ AND 1<>1]]>
				</otherwise>
			</choose>
		</if>
	</select>

	<select id="findSellerRefundOrderStatusCount" parameterType="OrderExceptionDto" resultMap="buyerRejectOrderResultMap"  useCache="false">
		SELECT
		T1.ORDER_STATUS AS orderStatus,COUNT(T1.ORDER_STATUS) AS orderCount,T3.PAY_TYPE AS payType
		FROM
		T_ORDER_EXCEPTION T1
		LEFT JOIN T_ORDER T2 ON T1.ORDER_ID = T2.ORDER_ID
		LEFT JOIN T_SYSTEM_PAY_TYPE T3 ON T2.PAY_TYPE_ID = T3.PAY_TYPE_ID
		LEFT JOIN T_USERMANAGE_ENTERPRISE T4 ON T1.CUST_ID = T4.ENTERPRISE_ID
		WHERE
		T1.RETURN_TYPE = '1'<!--退货-->
		AND	T1.SUPPLY_ID = #{supplyId}
		<if test="exceptionOrderId!= null and exceptionOrderId!= ''">
			AND T1.EXCEPTION_ORDER_ID LIKE CONCAT('%',#{exceptionOrderId},'%' )
		</if>
		<if test="flowId!= null and flowId!= ''">
			AND T1.FLOW_ID LIKE CONCAT('%',#{flowId},'%' )
		</if>
		<if test="custName!= null and custName!= ''">
			AND T1.CUST_NAME LIKE CONCAT('%',#{custName},'%' )
		</if>
		<if test="startTime!= null and startTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME >= #{startTime} ]]>
		</if>
		<if test="endTime!= null and endTime!= ''">
			<![CDATA[ AND T1.ORDER_CREATE_TIME <= #{endTime} ]]>
		</if>
		<if test="province !=null and province != '' ">
			AND T4.PROVINCE = #{province}
		</if>
		<if test="city !=null and city != ''">
			AND T4.CITY = #{city}
		</if>
		<if test="area !=null and area != ''">
			AND T4.DISTRICT = #{area}
		</if>
		GROUP BY T1.ORDER_STATUS,T3.PAY_TYPE
	</select>

	<!--换货订单详情-->
	<resultMap id="changeGoodsOrderDetailsResultMap" type="OrderExceptionDto" extends="OrderExceptionResultMapper">
		<result column="PAY_TYPE" property="payType"/>
		<result column="PAY_TYPE_NAME" property="payTypeName"/>
		<result column="bill_type" property="billType"/>
		<association property="orderDelivery" column="flow_id" select="com.yyw.yhyc.order.mapper.OrderDeliveryMapper.getByFlowId"></association>
		<collection property="orderDeliveryList" column="exception_order_id" select="com.yyw.yhyc.order.mapper.OrderDeliveryMapper.getOrderDeliveryByFlowId"/>
		<collection property="orderReturnList" column="exception_order_id" select="com.yyw.yhyc.order.mapper.OrderReturnMapper.getByExceptionOrderId"/>
	</resultMap>

	<select id="getChangeGoodsOrderDetails" parameterType="OrderExceptionDto"  resultMap="changeGoodsOrderDetailsResultMap">
		SELECT
		<include refid="T1commonProcessDateColumns"/>,T2.bill_type,T3.PAY_TYPE,T3.PAY_TYPE_NAME
		FROM
		t_order_exception T1
		LEFT JOIN t_order T2 ON T1.order_id=T2.order_id
		LEFT JOIN t_system_pay_type T3 ON T2.pay_type_id = T3.pay_type_id
		WHERE T1.exception_order_id=#{exceptionOrderId}
		<if test="custId!= null and custId!= ''">
			AND T1.cust_Id=#{custId}
		</if>
		<if test="supplyId!= null and supplyId!= ''">
			AND T1.supply_id=#{supplyId}
		</if>
	</select>

	<select id="getConfirmHistoryExceptionMoney" parameterType="java.lang.String" resultType="java.math.BigDecimal"  useCache="false">
		SELECT
	  IFNULL(SUM(T1.ORDER_MONEY),0)
		FROM
		T_ORDER_EXCEPTION T1
		WHERE
		((T1.RETURN_TYPE = '1' AND T1.ORDER_STATUS = '8')
		OR (T1.RETURN_TYPE = '4' AND T1.ORDER_STATUS = '4'))
		AND T1.FLOW_ID=#{flowId}
	</select>
</mapper>